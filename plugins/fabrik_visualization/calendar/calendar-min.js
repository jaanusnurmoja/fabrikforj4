/*! Fabrik */
var fabrikCalendar=new Class({Implements:[Options],options:{days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tues","Wed","Thur","Fri","Sat"],months:["January","Feburary","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sept","Oct","Nov","Dec"],viewType:"month",calendarId:1,tmpl:"default",Itemid:0,colors:{bg:"#F7F7F7",highlight:"#FFFFDF",headingBg:"#C3D9FF",today:"#dddddd",headingColor:"#135CAE",entryColor:"#eeffff"},eventLists:[],listid:0,popwiny:0,timeFormat:"%X",urlfilters:[],url:{add:"index.php?option=com_fabrik&controller=visualization.calendar&view=visualization&task=getEvents&format=raw",del:"index.php?option=com_fabrik&controller=visualization.calendar&view=visualization&task=deleteEvent&format=raw"},monthday:{width:90,height:120},restFilterStart:"na",j3:!1,showFullDetails:!1,readonly:!1,readonlyMonth:!1,dateLimits:{min:"",max:""}},initialize:function(t){this.firstRun=!0,this.el=document.id(t),this.SECOND=1e3,this.MINUTE=60*this.SECOND,this.HOUR=60*this.MINUTE,this.DAY=24*this.HOUR,this.WEEK=7*this.DAY,this.date=new Date,this.selectedDate=new Date,this.entries=$H(),this.droppables={month:[],week:[],day:[]},this.fx={},this.ajax={},"null"!==typeOf(this.el.getElement(".calendar-message"))&&(this.fx.showMsg=new Fx.Morph(this.el.getElement(".calendar-message"),{duration:700}),this.fx.showMsg.set({opacity:0})),this.colwidth={},this.windowopts={id:"addeventwin",title:"add/edit event",loadMethod:"xhr",minimizable:!1,evalScripts:!0,width:380,height:320,onContentLoaded:function(t){t.fitToContent()}.bind(this)},Fabrik.addEvent("fabrik.form.submitted",function(t,e){this.ajax.updateEvents.send(),Fabrik.Windows.addeventwin.close()}.bind(this))},removeFormEvents:function(i){this.entries.each(function(t,e){void 0!==t&&t.formid===i&&this.entries.dispose(e)}.bind(this))},_makeEventRelDiv:function(i,t,e,s){var n,o=i.label,a=(t.left==t.left&&t.left,t["margin-left"]==t["margin-left"]&&t["margin-left"],""!==i.colour?i.colour:this.options.colors.entryColor),a=(0===t.startMin&&(t.startMin=t.startMin+"0"),0===t.endMin&&(t.endMin=t.endMin+"0"),t.view,{"background-color":this._getColor(a,e),width:t.width,cursor:"pointer","margin-left":t["margin-left"],top:t.top.toInt()+"px",position:"absolute",border:"1px solid #666666","border-right":"0","border-left":"0",overflow:"auto",opacity:.6,padding:"0 4px"}),e=(t.height&&(a.height=t.height.toInt()+"px"),t.left&&(a.left=t.left.toInt()+1+"px"),a["max-width"]=t["max-width"]?t["max-width"]-10+"px":"","fabrikEvent_"+i._listid+"_"+i.id);return s&&"monthView"!==t.view&&(e+=s.className.replace(" ","")),"monthView"===t.view&&--a.width,this.options.j3?(s="",i._canDelete&&(s+=this.options.buttons.del),i._canEdit&&!this.options.readonly&&(s+=this.options.buttons.edit),i._canView&&(s+=this.options.buttons.view),t={start:Date.parse(i.startdate_locale).format(this.options.timeFormat),end:Date.parse(i.enddate_locale).format(this.options.timeFormat)},t=Joomla.JText._("PLG_VISUALIZATION_CALENDAR_EVENT_START_END").substitute(t),""!==s&&(t+='<hr /><div class="btn-group" style="text-align:center;display:block">'+s+"</div>"),n=new Element("a",{class:"fabrikEvent label "+i.status,id:e,styles:a,rel:"popover","data-original-title":o+'<button class="close" data-popover="'+e+'">&times;</button>',"data-bs-content":t,"data-bs-placement":"top","data-html":"true","data-bs-trigger":"click"}),this.options.showFullDetails?n.set("data-task","viewCalEvent"):"undefined"!=typeof jQuery&&(jQuery(n).popover(),n.addEvent("click",function(t){this.popOver=n}.bind(this)),n.addEvent("dblclick",function(t){t.stop()}.bind(this)))):(n=new Element("div",{class:"fabrikEvent label",id:e,styles:a}),this.options.showFullDetails?n.set("data-task","viewCalEvent"):n.addEvent("mouseenter",function(t){this.doPopupEvent(t,i,o)}.bind(this))),s=(""!==i.link&&!1===this.options.readonly&&!1===this.options.j3?new Element("a",{href:i.link,class:"fabrikEditEvent",events:{click:function(t){var e;Fabrik.fireEvent("fabrik.viz.calendar.event",[t]),i.custom||(t.stop(),e={},t=t.target.getParent(".fabrikEvent").id.replace("fabrikEvent_","").split("_"),e.rowid=t[1],e.listid=t[0],this.addEvForm(e))}.bind(this)}}):i.custom?(o=""===o?"click":o,new Element("a",{href:i.link,events:{click:function(t){Fabrik.fireEvent("fabrik.viz.calendar.event",[t])}}})):new Element("span")).set("html",o),n.adopt(s),n},doPopupEvent:function(t,e,i){var s;this.activeHoverEvent;this.popWin&&(this.activeHoverEvent=t.target.hasClass("fabrikEvent")?t.target:t.target.getParent(".fabrikEvent"),e._canDelete?this.popWin.getElement(".popupDelete").show():this.popWin.getElement(".popupDelete").hide(),e._canEdit?(this.popWin.getElement(".popupEdit").show(),this.popWin.getElement(".popupView").hide()):(this.popWin.getElement(".popupEdit").hide(),this.popWin.getElement(".popupView").show()),e=this.activeHoverEvent?this.activeHoverEvent.getCoordinates():{top:0,left:0},(s=this.popup.getElement("div[class=popLabel]")).empty(),s.set("text",i),this.activeDay=t.target.getParent(),e.top,this.popWin.getSize().y,s={opacity:[0,1],top:[e.top+50,e.top-10]},this.inFadeOut=!1,this.popWin.setStyles({left:e.left+20,top:e.top}),this.fx.showEventActions.cancel().set({opacity:0}).start.delay(500,this.fx.showEventActions,s))},_getFirstDayInMonthCalendar:function(t){var e,i=new Date;if(i.setTime(t.valueOf()),t.getDay()!==this.options.first_week_day&&((e=t.getDay()-this.options.first_week_day)<0&&(e=7+e),t.setTime(t.valueOf()-24*e*60*60*1e3)),i.getMonth()===t.getMonth())for(;1<t.getDate();)t.setTime(t.valueOf()-this.DAY);return t},showMonth:function(){for(var l=new Date,t=(l.setTime(this.date.valueOf()),l.setDate(1),l=this._getFirstDayInMonthCalendar(l),this.el.getElements(".monthView tr")),h=1;h<t.length;h++){var e=t[h].getElements("td"),r=0;e.each(function(a){a.setProperties({class:""}),a.addClass(l.getTime()),l.getMonth()!==this.date.getMonth()&&a.addClass("otherMonth"),this.selectedDate.isSameDay(l)&&a.addClass("selectedDay"),a.empty(),a.adopt(new Element("div",{class:"date",styles:{"background-color":this._getColor("#E8EEF7",l)}}).appendText(l.getDate()));var d=0;this.entries.each(function(t){(""!==t.enddate&&l.isDateBetween(t.startdate,t.enddate)||""===t.enddate&&t.startdate.isSameDay(l))&&d++}.bind(this));this.entries.each(function(t){var e,i,s,n,o;(""!==t.enddate&&l.isDateBetween(t.startdate,t.enddate)||""===t.enddate&&t.startdate.isSameDay(l))&&(e=a.getElements(".fabrikEvent").length,i=20,s=a.getElement(".date").getSize().y,i=Math.floor((a.getSize().y-d-s)/d),s=a.getSize().y*(h-1)+this.el.getElement(".monthView .dayHeading").getSize().y+s,this.colwidth[".monthView"]=this.colwidth[".monthView"]||a.getSize().x,o=a.getSize().x,n=(o=this.colwidth[".monthView"])*r,(o={view:"monthView","max-width":o}).top=s+=e*i,window.ie&&(o.left=n),o.startHour=t.startdate.getHours(),o.endHour=t.enddate.getHours(),o.startMin=t.startdate.getMinutes(),o.endMin=t.enddate.getMinutes(),o["margin-left"]=0,a.adopt(this._makeEventRelDiv(t,o,l,a))),0}.bind(this)),l.setTime(l.getTime()+this.DAY),r++}.bind(this))}document.addEvent("mousemove",function(t){t.target;var e=t.client.x,t=t.client.y,i=this.activeArea;"null"!==typeOf(i)&&"null"!==typeOf(this.activeDay)&&(e<=i.left||e>=i.right||t<=i.top||t>=i.bottom)&&(this.inFadeOut||(t={opacity:[1,0],top:[(e=this.activeHoverEvent.getCoordinates()).top-10,e.top+50]},this.fx.showEventActions.cancel().start.delay(500,this.fx.showEventActions,t)),this.activeDay=null)}.bind(this)),this.entries.each(function(t){this.el.getElement(".fabrikEvent_"+t._listid+"_"+t.id)}.bind(this)),this._highLightToday(),this.el.getElement(".monthDisplay").innerHTML=this.options.months[this.date.getMonth()]+" "+this.date.getFullYear()},_makePopUpWin:function(){var t,e;if(!this.options.readonly)return"null"===typeOf(this.popup)&&(t=new Element("div",{class:"popLabel"}),e=new Element("div",{class:"popupDelete"}).set("html",this.options.buttons),this.popup=new Element("div",{class:"popWin",styles:{position:"absolute"}}).adopt([t,e]),this.popup.inject(document.body),this.activeArea=null,this.fx.showEventActions=new Fx.Morph(this.popup,{duration:500,transition:Fx.Transitions.Quad.easeInOut,onCancel:function(){}.bind(this),onComplete:function(t){var e,i,s,n;this.activeHoverEvent&&(e=this.popup.getCoordinates(),i=this.activeHoverEvent.getCoordinates(),s=window.getScrollTop(),(n={}).left=(e.left<i.left?e:i).left,n.top=(e.top<i.top?e:i).top,n.top=n.top-s,n.right=(e.right>i.right?e:i).right,n.bottom=(e.bottom>i.bottom?e:i).bottom,n.bottom=n.bottom-s,this.activeArea=n,this.inFadeOut=!1)}.bind(this)})),this.popup},makeDragMonthEntry:function(t){},removeWeekEvents:function(){for(var t=this.date.getDay(),e=(t-=this.options.first_week_day.toInt(),new Date),i=(e.setTime(this.date.getTime()-t*this.DAY),{}),s=this.el.getElements(".weekView tr"),n=1;n<s.length;n++){e.setHours(n-1,0,0),1!==n&&e.setTime(e.getTime()-6*this.DAY);var o=s[n].getElements("td");for(j=1;j<o.length;j++){"null"===typeOf(i[j-1])&&(i[j-1]=[]);var a=o[j];i[j-1].push(a),1!==j&&e.setTime(e.getTime()+this.DAY),a.addClass("day"),"null"!==typeOf(a.retrieve("calevents"))&&a.retrieve("calevents").each(function(t){t.destroy()}),a.eliminate("calevents"),a.className="",a.addClass("day"),a.addClass(e.getTime()-this.HOUR),this.selectedDate.isSameWeek(e)&&this.selectedDate.isSameDay(e)?a.addClass("selectedDay"):a.removeClass("selectedDay")}}return i},showWeek:function(){var t=this.date.getDay(),e=(t-=this.options.first_week_day.toInt(),new Date),d=(e.setTime(this.date.getTime()-t*this.DAY),new Date),s=(d.setTime(this.date.getTime()-t*this.DAY),new Date);s.setTime(this.date.getTime()+(6-t)*this.DAY),this.el.getElement(".monthDisplay").innerHTML=e.getDate()+"  "+this.options.months[e.getMonth()]+" "+e.getFullYear()+" - ",this.el.getElement(".monthDisplay").innerHTML+=s.getDate()+"  "+this.options.months[s.getMonth()]+" "+s.getFullYear();var n,o,a=this.el.getElements(".weekView tr")[0].getElements("th"),l=this.removeWeekEvents();for(i=0;i<a.length;i++){a[i].className="dayHeading",a[i].addClass(d.getTime()),o=a[i].getStyle("background-color"),n=this.options.shortDays[d.getDay()]+" "+d.getDate()+"/"+this.options.shortMonths[d.getMonth()],o=new Element("div",{styles:{"background-color":this._getColor(o,d)}}).set("text",n),a[i].empty().adopt(o);var h=10,r={},p={},c=l[i],u=(this.entries.each(function(t){var e=new Date(t.startdate_locale),s=new Date(t.enddate_locale);if(""!==t.enddate&&d.isDateBetween(e,s)||""===s&&e.isSameDay(d))for(var n=this._buildEventOpts({entry:t,curdate:d,divclass:".weekView",tdOffset:i}),o=n.startHour;o<=n.endHour;o++)r[o]="null"===typeOf(r[o])?0:r[o]+1}.bind(this)),1);Object.each(r,function(t){u<t&&(u=t)}),this.entries.each(function(t){var e=new Date(t.startdate_locale),s=new Date(t.enddate_locale);if(""!==t.enddate&&d.isDateBetween(e,s)||""===s&&e.isSameDay(d)){for(var n=this._buildEventOpts({entry:t,curdate:d,divclass:".weekView",tdOffset:i}),o=n.startHour;o<=n.endHour;o++)p[o]="null"===typeOf(p[o])?0:p[o]+1;for(var a=0,o=n.startHour;o<=n.endHour;o++)a<p[o]&&(a=p[o]);s=Math.max(0,n.startHour-this.options.open),e=(td=c[s],h=Math.floor((td.getSize().x-u)/(u+1)),n.width=h+"px",n["margin-left"]=a*(h+1),this._makeEventRelDiv(t,n,null,td)),s=(e.addClass("week-event"),e.inject(document.body),e.getStyle("padding-left").toInt()+e.getStyle("padding-right").toInt()),t=(e.setStyle("width",e.getStyle("width").toInt()-s+"px"),e.store("opts",n),e.store("relativeTo",td),e.store("gridSize",u),td.retrieve("calevents",[]));t.push(e),td.store("calevents",t),e.position({relativeTo:td,position:"upperLeft"})}}.bind(this)),d.setTime(d.getTime()+this.DAY)}},_buildEventOpts:function(t){var e=t.curdate,i=new CloneObject(t.entry,!0,["enddate","startdate"]),s=this.el.getElements(t.divclass+" tr"),n=new Date(i.startdate_locale),o=new Date(i.enddate_locale),a=(a=n.isSameDay(e)?n.getHours()-this.options.open:0)<0?0:a,d=t.tdOffset,s=(i.label=i.label||"",s[1+a].getElements("td")[d+1]),l=i.startdate.getHours(),h=s.getSize().y,r=(this.colwidth[t.divclass]=this.colwidth[t.divclass]||s.getSize().x,this.el.getElement(t.divclass).getElement("tr").getSize().y),d=(colwidth=this.colwidth[t.divclass])*d,p=(d+=this.el.getElement(t.divclass).getElement("td").getSize().x,Math.ceil(o.getHours()-n.getHours())),a=(0===p&&(p=1),n.isSameDay(o)||(p=0!==this.options.open||24!==this.options.close?this.options.close-this.options.open+1:24,n.isSameDay(e)?p=0!==this.options.open||24!==this.options.close?this.options.close-this.options.open+1:24-n.getHours():(n.setHours(0),o.isSameDay(e)&&(p=0!==this.options.open||24!==this.options.close?this.options.close-this.options.open:o.getHours()))),r+=h*a,h*p),e=(o.isSameDay(e)&&(a+=o.getMinutes()/60*h),n.isSameDay(e)&&(r+=n.getMinutes()/60*h,a-=n.getMinutes()/60*h),s.getElements(".fabrikEvent")),h=colwidth/(e.length+1),c=h*e.length;e.setStyle("width",h+"px"),t.divclass.substr(1,t.divclass.length);return h-=s.getStyle("border-width").toInt(),(t={"z-index":999,"margin-left":c+"px",height:a,view:"weekView","background-color":this._getColor(this.options.colors.headingBg)})["max-width"]=h+"px",t.left=d,t.top=r,t.color=this._getColor(this.options.colors.headingColor,n),t.startHour=n.getHours(),t.endHour=t.startHour+p,t.startMin=n.getMinutes(),t.endMin=o.getMinutes(),i.startdate.setHours(l),t},removeDayEvents:function(){for(var t=new Date,e=(new Date).get("gmtoffset").replace(/0+$/,"").toInt(),i=[],s=(t.setTime(this.date.valueOf()),t.setHours(0,0),this.el.getElements(".dayView tr")),n=1;n<s.length;n++){t.setHours(n-1+e,0);var o=s[n].getElements("td")[1];"null"!==typeOf(o)&&(i.push(o),o.className="",o.addClass("day"),"null"!==typeOf(o.retrieve("calevents"))&&o.retrieve("calevents").each(function(t){t.destroy()}),o.eliminate("calevents"),o.addClass(t.getTime()-this.HOUR),o.set("data-date",t))}return i},showDay:function(){var t,o,e=this.el.getElements(".dayView tr"),a=(thbg=e[0].childNodes[1].getStyle("background-color"),ht=this.options.days[this.date.getDay()],t=new Element("div",{styles:{"background-color":this._getColor(thbg,this.date)}}).set("text",ht),e[0].childNodes[1].empty().adopt(t),this.removeDayEvents()),d={},s={},l=(this.entries.each(function(t){if(""!==t.enddate&&this.date.isDateBetween(t.startdate,t.enddate)||""===t.enddate&&t.startdate.isSameDay(firstDate))for(var e=this._buildEventOpts({entry:t,curdate:this.date,divclass:".dayView",tdOffset:0}),i=e.startHour;i<=e.endHour;i++)s[i]="null"===typeOf(s[i])?0:s[i]+1}.bind(this)),1);Object.each(s,function(t){l<t&&(l=t)}),this.entries.each(function(t){if(""!==t.enddate&&this.date.isDateBetween(t.startdate,t.enddate)||""===t.enddate&&t.startdate.isSameDay(firstDate)){var e=this._buildEventOpts({entry:t,curdate:this.date,divclass:".dayView",tdOffset:0}),i=Math.max(0,e.startHour-this.options.open);td=a[i],o=Math.floor((td.getSize().x-l)/(l+1)),e.width=o+"px";for(var s=e.startHour;s<=e.endHour;s++)d[s]="null"===typeOf(d[s])?0:d[s]+1;for(var n=0,s=e.startHour;s<=e.endHour;s++)n<d[s]&&(n=d[s]);e["margin-left"]=n*(o+1);i=this._makeEventRelDiv(t,e,null,td),t=(i.addClass("day-event"),i.store("relativeTo",td),i.store("gridSize",l),i.inject(document.body),i.getStyle("padding-left").toInt()+i.getStyle("padding-right").toInt()),t=(i.setStyle("width",i.getStyle("width").toInt()-t+"px"),i.store("opts",e),td.retrieve("calevents",[]));t.push(i),td.store("calevents",t),i.position({relativeTo:td,position:"upperLeft"})}}.bind(this)),this.el.getElement(".monthDisplay").innerHTML=this.date.getDate()+"  "+this.options.months[this.date.getMonth()]+" "+this.date.getFullYear()},renderMonthView:function(){this.fadePopWin(0);var t,e=this._getFirstDayInMonthCalendar(new Date),i=this.options.days.slice(this.options.first_week_day).concat(this.options.days.slice(0,this.options.first_week_day)),s=new Date;if(s.setTime(e.valueOf()),e.getDay()!==this.options.first_week_day&&(t=e.getDay()-this.options.first_week_day,s.setTime(e.valueOf()-24*t*60*60*1e3)),this.options.viewType="monthView",this.setAddButtonState(),!this.mothView){for(tbody=new Element("tbody",{class:"viewContainerTBody"}),l=new Element("tr"),r=0;r<7;r++)l.adopt(new Element("th",{class:"dayHeading",styles:{width:"80px",height:"20px","text-align":"center",color:this._getColor(this.options.colors.headingColor,s),"background-color":this._getColor(this.options.colors.headingBg,s)}}).appendText(i[r])),s.setTime(s.getTime()+this.DAY);tbody.appendChild(l);for(var n=this.options.colors.highlight,o=this.options.colors.bg,a=this.options.colors.today,d=0;d<6;d++){for(var l=new Element("tr"),h=this,r=0;r<7;r++){var p=this.options.colors.bg,c=this.selectedDate.isSameDay(e)?"selectedDay":"";l.adopt(new Element("td",{class:"day "+e.getTime()+c,styles:{width:this.options.monthday.width+"px",height:this.options.monthday.height+"px","background-color":p,"vertical-align":"top",padding:0,border:"1px solid #cccccc"},events:{mouseenter:function(){this.setStyles({"background-color":n})},mouseleave:function(){this.set("morph",{duration:500,transition:Fx.Transitions.Sine.easeInOut});var t=this.hasClass("today")?a:o;this.morph({"background-color":[n,t]})},click:function(t){h.selectedDate.setTime(this.className.split(" ")[1]),h.date.setTime(h._getTimeFromClassName(this.className)),h.el.getElements("td").each(function(t){t.removeClass("selectedDay"),t!==this&&t.setStyles({"background-color":"#F7F7F7"})}.bind(this)),this.addClass("selectedDay")},dblclick:function(t){!1===this.options.readonlyMonth&&this.openAddEvent(t,"month")}.bind(this)}})),e.setTime(e.getTime()+this.DAY)}tbody.appendChild(l)}this.mothView=new Element("div",{class:"monthView",styles:{position:"relative"}}).adopt(new Element("table",{styles:{"border-collapse":"collapse"}}).adopt(tbody)),this.el.getElement(".viewContainer").appendChild(this.mothView)}this.showView("monthView")},setAddButtonState:function(){var t=this.el.getElement(".addEventButton");"null"!==typeOf(t)&&("monthView"===this.options.viewType&&!0===this.options.readonlyMonth?t.hide():t.show())},_getTimeFromClassName:function(t){return t.replace("today","").replace("selectedDay","").replace("day","").replace("otherMonth","").trim()},openAddEvent:function(t,e){var i,s,n,o,a;!1===this.options.canAdd||"monthView"===this.options.viewType&&!0===this.options.readonlyMonth||(t.stop(),i="addEventButton"===t.target.className?(new Date).getTime():this._getTimeFromClassName(t.target.className),this.dateInLimits(i)&&(t.target.get("data-date")&&console.log("data-date = ",t.target.get("data-date")),this.date.setTime(i),d=0,isNaN(i)||""===i||((t=new Date).setTime(i),a=(a=t.getMonth()+1)<10?"0"+a:a,s=(s=t.getDate())<10?"0"+s:s,o="month"!==e?(n=(n=t.getHours())<10?"0"+n:n,(o=t.getMinutes())<10?"0"+o:o):n="00",this.doubleclickdate=t.getFullYear()+"-"+a+"-"+s+" "+n+":"+o+":00",d="&jos_fabrik_calendar_events___start_date="+this.doubleclickdate),1<this.options.eventLists.length?this.openChooseEventTypeForm(this.doubleclickdate,i):(d="&"+this.options.eventLists[0].startdate_element+"="+this.doubleclickdate,(e={rowid:"",id:""}).listid=this.options.eventLists[0].value,this.addEvForm(e))))},dateInLimits:function(t){var e=new Date;if((e.setTime(t),""!==this.options.dateLimits.min)&&e<new Date(this.options.dateLimits.min))return alert(Joomla.JText._("PLG_VISUALIZATION_CALENDAR_DATE_ADD_TOO_EARLY")),!1;if(""!==this.options.dateLimits.max&&new Date(this.options.dateLimits.max)<e)return alert(Joomla.JText._("PLG_VISUALIZATION_CALENDAR_DATE_ADD_TOO_LATE")),!1;return!0},openChooseEventTypeForm:function(t,e){t="index.php?option=com_fabrik&tmpl=component&view=visualization&controller=visualization.calendar&task=chooseaddevent&id="+this.options.calendarId+"&d="+t+"&rawd="+e;t+="&renderContext="+this.el.id.replace(/visualization_/,""),this.windowopts.contentURL=t,this.windowopts.id="chooseeventwin",this.windowopts.onContentLoaded=function(){new Fx.Scroll(window).toElement("chooseeventwin")},Fabrik.getWindow(this.windowopts)},addEvForm:function(t){"undefined"!=typeof jQuery&&jQuery(this.popOver).popover("hide"),this.windowopts.id="addeventwin";var e="index.php?option=com_fabrik&controller=visualization.calendar&view=visualization&task=addEvForm&format=raw&listid="+t.listid+"&rowid="+t.rowid,i=(e=(e+="&jos_fabrik_calendar_events___visualization_id="+this.options.calendarId)+("&visualizationid="+this.options.calendarId),t.nextView&&(e+="&nextview="+t.nextView),e+="&fabrik_window_id="+this.windowopts.id,void 0!==this.doubleclickdate&&(e+="&start_date="+this.doubleclickdate),this.windowopts.type="window",this.windowopts.contentURL=e,this.options.filters);this.windowopts.onContentLoaded=function(t){i.each(function(t){if(document.id(t.key))switch(document.id(t.key).get("tag")){case"select":document.id(t.key).selectedIndex=t.val;break;case"input":document.id(t.key).value=t.val}}),this.fitToContent(!1)},Fabrik.getWindow(this.windowopts)},_highLightToday:function(){var i=new Date;this.el.getElements(".viewContainerTBody td").each(function(t){var e=new Date(this._getTimeFromClassName(t.className).toInt());i.equalsTo(e)?t.addClass("today"):t.removeClass("today")}.bind(this))},centerOnToday:function(){this.date=new Date,this.showView()},renderDayView:function(){var t,e,s;if(this.fadePopWin(0),this.options.viewType="dayView",this.setAddButtonState(),!this.dayView){for(tbody=new Element("tbody"),t=new Element("tr"),e=0;e<2;e++)0===e?t.adopt(new Element("td",{class:"day"})):t.adopt(new Element("th",{class:"dayHeading",styles:{width:"80px",height:"20px","text-align":"center",color:this.options.headingColor,"background-color":this.options.colors.headingBg}}).appendText(this.options.days[this.date.getDay()]));for(tbody.appendChild(t),this.options.open=this.options.open<0?0:this.options.open,this.options.close=24<this.options.close||this.options.close<this.options.open?24:this.options.close,i=this.options.open;i<this.options.close+1;i++){for(t=new Element("tr"),e=0;e<2;e++)0===e?(s=1===i.length?i+"0:00":i+":00",t.adopt(new Element("td",{class:"day"}).appendText(s))):t.adopt(new Element("td",{class:"day",styles:{width:"100%",height:"10px","background-color":"#F7F7F7","vertical-align":"top",padding:0,border:"1px solid #cccccc"},events:{mouseenter:function(t){this.setStyles({"background-color":"#FFFFDF"})},mouseleave:function(t){this.setStyles({"background-color":"#F7F7F7"})},dblclick:function(t){this.openAddEvent(t,"day")}.bind(this)}}));tbody.appendChild(t)}this.dayView=new Element("div",{class:"dayView",styles:{position:"relative"}}).adopt(new Element("table",{class:"",styles:{"border-collapse":"collapse"}}).adopt(tbody)),this.el.getElement(".viewContainer").appendChild(this.dayView)}this.showView("dayView")},hideDayView:function(){this.el.getElement(".dayView")&&(this.el.getElement(".dayView").hide(),this.removeDayEvents())},hideWeekView:function(){this.el.getElement(".weekView")&&(this.el.getElement(".weekView").hide(),this.removeWeekEvents())},showView:function(t){switch(this.hideDayView(),this.hideWeekView(),this.el.getElement(".monthView")&&this.el.getElement(".monthView").hide(),this.el.getElement("."+this.options.viewType).style.display="block",this.options.viewType){case"dayView":this.showDay();break;case"weekView":this.showWeek();break;default:this.showMonth()}Cookie.write("fabrik.viz.calendar.view",this.options.viewType)},renderWeekView:function(){var t,e,i,s,n,o;if(this.fadePopWin(0),n=!1===this.options.showweekends?6:8,this.options.viewType="weekView",this.setAddButtonState(),!this.weekView){for(s=new Element("tbody"),i=new Element("tr"),e=0;e<n;e++)0===e?i.adopt(new Element("td",{class:"day"})):i.adopt(new Element("th",{class:"dayHeading",styles:{width:this.options.weekday.width+"px",height:this.options.weekday.height-10+"px","text-align":"center",color:this.options.headingColor,"background-color":this.options.colors.headingBg},events:{click:function(t){t.stop(),this.selectedDate.setTime(t.target.className.replace("dayHeading ","").toInt());var i=new Date;t.target.getParent().getParent().getElements("td").each(function(t){var e=t.className.replace("day ","").replace(" selectedDay").toInt();i.setTime(e),i.getDayOfYear()===this.selectedDate.getDayOfYear()?t.addClass("selectedDay"):t.removeClass("selectedDay")}.bind(this))}.bind(this)}}).appendText(this.options.days[e-1]));for(s.appendChild(i),this.options.open=this.options.open<0?0:this.options.open,24<this.options.close||this.options.close<this.options.open?this.options.close=24:this.options.close,t=this.options.open;t<this.options.close+1;t++){for(i=new Element("tr"),e=0;e<n;e++)0===e?(o=1===t.length?t+"0:00":t+":00",i.adopt(new Element("td",{class:"day"}).set("text",o))):i.adopt(new Element("td",{class:"day",styles:{width:this.options.weekday.width+"px",height:this.options.weekday.height+"px","background-color":"#F7F7F7","vertical-align":"top",padding:0,border:"1px solid #cccccc"},events:{mouseenter:function(t){this.hasClass("selectedDay")||this.setStyles({"background-color":"#FFFFDF"})},mouseleave:function(t){this.hasClass("selectedDay")||this.setStyles({"background-color":"#F7F7F7"})},dblclick:function(t){this.openAddEvent(t,"week")}.bind(this)}}));s.appendChild(i)}this.weekView=new Element("div",{class:"weekView",styles:{position:"relative"}}).adopt(new Element("table",{styles:{"border-collapse":"collapse"}}).adopt(s)),this.el.getElement(".viewContainer").appendChild(this.weekView)}this.showWeek(),this.showView("weekView")},repositionEvents:function(){document.getElements("a.week-event, a.day-event").each(function(t){var e=t.retrieve("relativeTo"),i=(t.position({relativeTo:e,position:"upperLeft"}),t.retrieve("gridSize")),e=Math.floor((e.getSize().x-i)/i),i=t.getStyle("padding-left").toInt()+t.getStyle("padding-right").toInt();t.setStyle("width",(e-=i)+"px")})},render:function(t){this.setOptions(t),window.addEvent("resize",function(){this.repositionEvents()}.bind(this)),this.y=this.el.getPosition().y;t=function(){var t=this.el.getPosition().y;t!==this.y&&(this.y=t,this.repositionEvents())}.bind(this),window.setInterval(t,200),document.addEvent("click:relay(button[data-task=deleteCalEvent], a[data-task=deleteCalEvent])",function(t,e){t.preventDefault(),this.deleteEntry()}.bind(this)),document.addEvent("click:relay(button[data-task=editCalEvent], a[data-task=editCalEvent])",function(t,e){t.preventDefault(),this.editEntry()}.bind(this)),document.addEvent("click:relay(button[data-task=viewCalEvent], a[data-task=viewCalEvent])",function(t,e){t.preventDefault(),this.activeHoverEvent||(this.activeHoverEvent=e.hasClass("fabrikEvent")?e:e.getParent(".fabrikEvent")),this.viewEntry()}.bind(this)),document.addEvent("click:relay(a.fabrikEvent)",function(t,e){this.activeHoverEvent=t.target.hasClass("fabrikEvent")?t.target:t.target.getParent(".fabrikEvent")}.bind(this)),this.windowopts.title=Joomla.JText._("PLG_VISUALIZATION_CALENDAR_ADD_EDIT_EVENT"),this.windowopts.y=this.options.popwiny,this.popWin=this._makePopUpWin(),t=this.options.urlfilters,t.visualizationid=this.options.calendarId,this.firstRun&&(this.firstRun=!1,t.resetfilters=this.options.restFilterStart),this.ajax.updateEvents=new Request({url:this.options.url.add,data:t,evalScripts:!0,onSuccess:function(t){"null"!==typeOf(t)&&(t=t.stripScripts(!0),t=JSON.parse(t),this.addEntries(t),this.showView())}.bind(this)}),this.ajax.deleteEvent=new Request({url:this.options.url.del,data:{visualizationid:this.options.calendarId},onComplete:function(t){t=t.stripScripts(!0);t=JSON.parse(t);this.entries=$H(),this.addEntries(t)}.bind(this)}),"null"!==typeOf(this.el.getElement(".addEventButton"))&&this.el.getElement(".addEventButton").addEvent("click",function(t){this.openAddEvent(t)}.bind(this)),t=new Element("div",{class:"calendarNav"}).adopt(new Element("ul",{class:"viewMode"}).adopt([]));switch(this.el.appendChild(t),this.el.appendChild(new Element("div",{class:"viewContainer"})),"null"!==typeOf(Cookie.read("fabrik.viz.calendar.date"))&&(this.date=new Date(Cookie.read("fabrik.viz.calendar.date"))),"null"===typeOf(Cookie.read("fabrik.viz.calendar.view"))?this.options.viewType:Cookie.read("fabrik.viz.calendar.view")){case"dayView":this.renderDayView();break;case"weekView":this.renderWeekView();break;default:this.renderMonthView()}this.el.getElement(".nextPage").addEvent("click",function(t){this.nextPage(t)}.bind(this)),this.el.getElement(".previousPage").addEvent("click",function(t){this.previousPage(t)}.bind(this)),this.options.show_day&&this.el.getElement(".dayViewLink").addEvent("click",function(t){this.renderDayView(t)}.bind(this)),this.options.show_week&&this.el.getElement(".weekViewLink").addEvent("click",function(t){this.renderWeekView(t)}.bind(this)),(this.options.show_week||this.options.show_day)&&this.el.getElement(".monthViewLink").addEvent("click",function(t){this.renderMonthView(t)}.bind(this)),this.el.getElement(".centerOnToday").addEvent("click",function(t){this.centerOnToday(t)}.bind(this)),this.showMonth(),this.ajax.updateEvents.send()},showMessage:function(t){this.el.getElement(".calendar-message").set("html",t),this.fx.showMsg.start({opacity:[0,1]}).chain(function(){this.start.delay(2e3,this,{opacity:[1,0]})})},addEntry:function(t,e){var i,s,n,o;e.startdate&&""!==(i=(i=e.startdate.split(" "))[0]).trim()&&(o=(o=(o=e.startdate.split(" "))[1]).split(":"),i=i.split("-"),s=new Date,n=i[1].toInt()-1,s.setYear(i[0]),s.setMonth(n,i[2]),s.setDate(i[2]),s.setHours(o[0].toInt()),s.setMinutes(o[1].toInt()),s.setSeconds(o[2].toInt()),e.startdate=s,this.entries.set(t,e),e.enddate)&&""!==(i=(i=e.enddate.split(" "))[0]).trim()&&("0000-00-00"===i?e.enddate=e.startdate:(o=(o=(o=e.enddate.split(" "))[1]).split(":"),i=i.split("-"),s=new Date,n=i[1].toInt()-1,s.setYear(i[0]),s.setMonth(n,i[2]),s.setDate(i[2]),s.setHours(o[0].toInt()),s.setMinutes(o[1].toInt()),s.setSeconds(o[2].toInt()),e.enddate=s))},deleteEntry:function(){var t=this.activeHoverEvent.id.replace("fabrikEvent_",""),e=t.split("_"),i=e[0];this.options.deleteables.contains(i)&&confirm(Joomla.JText._("PLG_VISUALIZATION_CALENDAR_CONF_DELETE"))&&(this.ajax.deleteEvent.options.data={id:e[1],listid:i},this.ajax.deleteEvent.send(),document.id(this.activeHoverEvent).fade("out"),this.fx.showEventActions.start({opacity:[1,0]}),this.removeEntry(t),this.activeDay=null)},editEntry:function(t){var e={},i=(e.id=this.options.formid,this.activeHoverEvent.id.replace("fabrikEvent_","").split("_"));e.rowid=i[1],e.listid=i[0],t&&t.stop(),this.addEvForm(e)},viewEntry:function(){var t={},e=(t.id=this.options.formid,this.activeHoverEvent.id.replace("fabrikEvent_","").split("_"));t.rowid=e[1],t.listid=e[0],t.nextView="details",this.addEvForm(t)},addEntries:function(t){(t=$H(t)).each(function(t,e){this.addEntry(e,t)}.bind(this)),this.showView()},removeEntry:function(t){this.entries.erase(t),this.showView()},nextPage:function(){switch(this.fadePopWin(0),this.options.viewType){case"dayView":this.date.setTime(this.date.getTime()+this.DAY),this.showDay();break;case"weekView":this.date.setTime(this.date.getTime()+this.WEEK),this.showWeek();break;case"monthView":this.date.setDate(1),this.date.setMonth(this.date.getMonth()+1),this.showMonth()}Cookie.write("fabrik.viz.calendar.date",this.date)},fadePopWin:function(t){this.popWin&&this.popWin.setStyle("opacity",t)},previousPage:function(){switch(this.fadePopWin(0),this.options.viewType){case"dayView":this.date.setTime(this.date.getTime()-this.DAY),this.showDay();break;case"weekView":this.date.setTime(this.date.getTime()-this.WEEK),this.showWeek();break;case"monthView":this.date.setMonth(this.date.getMonth()-1),this.showMonth()}Cookie.write("fabrik.viz.calendar.date",this.date)},addLegend:function(t){var i=new Element("ul");t.each(function(t){var e=new Element("li");e.adopt(new Element("div",{styles:{"background-color":t.colour}}),new Element("span").appendText(t.label)),i.appendChild(e)}.bind(this)),new Element("div",{class:"calendar-legend"}).adopt([new Element("h3").appendText(Joomla.JText._("PLG_VISUALIZATION_CALENDAR_KEY")),i]).inject(this.el,"after")},_getGreyscaleFromRgb:function(t){var e=parseInt(t.substring(1,3),16),i=parseInt(t.substring(3,5),16),t=parseInt(t.substring(5),16),e=parseInt(.3*e+.59*i+.11*t,10);return"#"+e.toString(16)+e.toString(16)+e.toString(16)},_getColor:function(t,e){return!this.options.greyscaledweekend||(new Color(t),"null"===typeOf(e))||0!==e.getDay()&&6!==e.getDay()?t:this._getGreyscaleFromRgb(t)}});Date._MD=new Array(31,28,31,30,31,30,31,31,30,31,30,31),Date.SECOND=1e3,Date.MINUTE=60*Date.SECOND,Date.HOUR=60*Date.MINUTE,Date.DAY=24*Date.HOUR,Date.WEEK=7*Date.DAY,Date.prototype.getMonthDays=function(t){var e=this.getFullYear();return void 0===t&&(t=this.getMonth()),0!=e%4||0==e%100&&0!=e%400||1!==t?Date._MD[t]:29},Date.prototype.isSameWeek=function(t){return this.getFullYear()===t.getFullYear()&&this.getMonth()===t.getMonth()&&this.getWeekNumber()===t.getWeekNumber()},Date.prototype.isSameDay=function(t){return this.getFullYear()===t.getFullYear()&&this.getMonth()===t.getMonth()&&this.getDate()===t.getDate()},Date.prototype.isSameHour=function(t){return this.getFullYear()===t.getFullYear()&&this.getMonth()===t.getMonth()&&this.getDate()===t.getDate()&&this.getHours()===t.getHours()},Date.prototype.isDateBetween=function(t,e){var t=1e4*t.getFullYear()+100*(t.getMonth()+1)+t.getDate(),e=1e4*e.getFullYear()+100*(e.getMonth()+1)+e.getDate(),i=1e4*this.getFullYear()+100*(this.getMonth()+1)+this.getDate();return t<=i&&i<=e};