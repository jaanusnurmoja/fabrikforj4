/*! Fabrik */
define(["jquery","fab/fileelement"],function(d,e){window.FbFileUpload=new Class({Extends:e,options:{folderSelect:!1,ajax_upload:!1,ajax_show_widget:!0,isCarousel:!1},initialize:function(e,t){var s=this;this.setPlugin("fileupload"),this.parent(e,t),this.container=d(this.container),this.toppath=this.options.dir,"1"===this.options.folderSelect&&!0===this.options.editable&&this.ajaxFolder(),this.doBrowseEvent=null,this.watchBrowseButton(),this.options.ajax_upload&&!1!==this.options.editable&&(Fabrik.fireEvent("fabrik.fileupload.plupload.build.start",this),this.watchAjax(),0!==Object.keys(this.options.files).length&&(this.uploader.trigger("FilesAdded",this.options.files),d.each(this.options.files,function(e,t){var i={filepath:t.path,uri:t.url,showWidget:!1},a=d(Fabrik.jLayouts["fabrik-progress-bar-success"])[0],o=d("#"+t.id).find(".bar")[0];s.uploader.trigger("UploadProgress",t),s.uploader.trigger("FileUploaded",t,{response:JSON.stringify(i)}),d(o).replaceWith(a)})),this.redraw()),this.doDeleteEvent=null,this.watchDeleteButton(),this.watchTab(),this.options.isCarousel&&(d(".slickCarousel").slick(),d(".slickCarouselImage").css("opacity","1")),this.options.isZoom&&(d(".slick-active").find("img").ezPlus({zoomType:"lens",lensShape:"round",lensSize:200}),d(".slickCarousel").on("beforeChange",function(e,t,i,a){d(".zoomWindowContainer,.zoomContainer").remove()}),d(".slickCarousel").on("afterChange",function(e,t,i){d(".slick-active").find("img").ezPlus({zoomType:"lens",lensShape:"round",lensSize:200})}))},redraw:function(){var e,t,i=d(this.element);this.options.editable&&this.options.ajax_upload&&(i=d("#"+i.prop("id")+"_browseButton"),t=d("#"+this.options.element+"_container"),e=i.position().left-t.position().left,0<(t=t.closest(".fabrikElement").find("input[type=file]")).length)&&((t=t.parent()).css({width:i.width(),height:i.height()}),t.css("top",e)),this.options.isCarousel&&d(".slickCarousel").slick("resize")},doBrowse:function(e){var t,a,i,o;window.File&&window.FileReader&&window.FileList&&window.Blob&&(a=this,(e=e.target.files[0]).type.match("image.*")?((t=new FileReader).onload=function(e){return function(e){var t=d(a.getContainer()),i=t.find("img");i.attr("src",e.target.result),i.closest(".fabrikHide").removeClass("fabrikHide"),t.find("[data-file]").addClass("fabrikHide")}}.bind(this)(e),t.readAsDataURL(e)):e.type.match("video.*")&&(o=d(this.getContainer()),0<(i=o.find("video")).length&&(i=this.makeVideoPreview()).appendTo(o),t=new window.FileReader,(t=window.URL||window.webKitURL)&&t.createObjectURL?(o=t.createObjectURL(e),i.attr("src",o)):window.FileReader?((t=new window.FileReader).onload=function(e){i.attr("src",e.target.result)},t.readAsDataURL(e)):console.log("Sorry, not so much")))},watchBrowseButton:function(){var e=d(this.element);this.options.useWIP&&!this.options.ajax_upload&&!1!==this.options.editable&&(e.off("change",this.doBrowseEvent),this.doBrowseEvent=this.doBrowse.bind(this),e.on("change",this.doBrowseEvent))},doDelete:function(e){e.preventDefault();var t,e=d(this.getContainer()),i=this,a=e.find("[data-file]");window.confirm(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_CONFIRM_SOFT_DELETE"))&&(t=a.data("join-pk-val"),new d.ajax({url:"",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"fileupload",method:"ajax_clearFileReference",element_id:this.options.id,formid:this.form.id,rowid:this.form.options.rowid,joinPkVal:t}}).done(function(){Fabrik.trigger("fabrik.fileupload.clearfileref.complete",i)}),window.confirm(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_CONFIRM_HARD_DELETE"))&&(this.makeDeletedImageField(this.groupid,a.data("file")).appendTo(e),Fabrik.fireEvent("fabrik.fileupload.delete.complete",this)),a.remove(),d(this.element).closest(".fabrikElement").find("img").attr("src",""!==this.options.defaultImage?Fabrik.liveSite+this.options.defaultImage:""))},watchDeleteButton:function(){var e=d(this.getContainer()).find("[data-file]");e.off("click",this.doDeleteEvent),this.doDeleteEvent=this.doDelete.bind(this),e.on("click",this.doDeleteEvent)},getFormElementsKey:function(e){return this.baseElementId=e,!this.options.inRepeatGroup&&this.options.ajax_upload&&1<this.options.ajax_max?this.options.listName+"___"+this.options.elementShortName:this.parent(e)},removeCustomEvents:function(){},cloned:function(e){if(this.options.ajax_upload)d(this.getContainer()).find(".plupload_container").prop("id",this.element.id+"_container"),d(this.getContainer()).find(".plupload").prop("id",this.element.id+"_dropList_container"),d(this.getContainer()).find(".plupload_filelist").prop("id",this.element.id+"_dropList"),d(this.getContainer()).find(".plupload_browsebutton").prop("id",this.element.id+"_browseButton"),d(this.getContainer()).find("input").remove(),this.watchAjax();else{var t=d(this.element);if(0===t.closest(".fabrikElement").length)return;t.closest(".fabrikElement").find("img").attr("src",""!==this.options.defaultImage?Fabrik.liveSite+this.options.defaultImage:""),d(this.getContainer()).find("[data-file]").remove(),this.watchBrowseButton()}this.parent(e)},decloned:function(e){0<d("#form_"+this.form.id).find('input[name="fabrik_deletedimages['+e+']"]').length&&this.makeDeletedImageField(e,this.options.value).inject(this.form.form),this.parent(e)},decreaseName:function(e){var t=this.getOrigField();return"null"!==typeOf(t)&&(t.name=this._decreaseName(t.name,e),t.id=this._decreaseId(t.id,e)),this.parent(e)},getOrigField:function(){var e=this.element.getParent(".fabrikElement"),t=e.getElement("input[name^="+this.origId+"_orig]");return t="null"===typeOf(t)?e.getElement("input[id^="+this.origId+"_orig]"):t},makeDeletedImageField:function(e,t){return d(document.createElement("input")).attr({type:"hidden",name:"fabrik_fileupload_deletedfile["+e+"][]",value:t})},makeVideoPreview:function(){var e=d(this.element);return d(document.createElement("video")).attr({id:e.prop("id")+"_video_preview",controls:!0})},update:function(e){var t;this.element&&(t=d(this.element),""===e?this.options.ajax_upload?(this.uploader.files=[],t.parent().find("[id$=_dropList] tr").remove()):t.val(""):(t=t.closest("div.fabrikSubElementContainer").find("img"))&&t.prop("src",e))},addDropArea:function(){var e;Fabrik.bootstraped&&(0<(e=this.container.find("tr.plupload_droptext")).length?e.show():(e=d(document.createElementget("tr")).addClass("plupload_droptext").html('<td colspan="4"><i class="icon-move"></i> '+Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_DRAG_FILES_HERE")+" </td>"),this.container.find("tbody").append(e)),this.container.find("thead").hide())},removeDropArea:function(){this.container.find("tr.plupload_droptext").hide()},watchAjax:function(){var n,e,t;!1!==this.options.editable&&(t=d((n=this).element).prop("id"),0!==(e=d(this.getElement())).length)&&(e=e.closest(".fabrikSubElementContainer"),this.container=e,this.options.ajax_show_widget&&!1!==this.options.canvasSupport&&(this.widget=new i(this.options.modalId,{imagedim:{x:200,y:200,w:this.options.winWidth,h:this.options.winHeight},cropdim:{w:this.options.cropwidth,h:this.options.cropheight,x:this.options.winWidth/2,y:this.options.winHeight/2},crop:this.options.crop,modalId:this.options.modalId,quality:this.options.quality})),this.pluploadContainer=e.find(".plupload_container"),this.pluploadFallback=e.find(".plupload_fallback"),this.droplist=e.find(".plupload_filelist"),e="index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax",e=(e+="&plugin=fileupload&"+this.options.ajaxToken+"=1")+"&method=ajax_upload&element_id="+this.options.elid,this.options.isAdmin&&(e="administrator/"+e),t={runtimes:this.options.ajax_runtime,browse_button:t+"_browseButton",container:t+"_container",drop_element:t+"_dropList_container",url:e,max_file_size:this.options.max_file_size+"kb",unique_names:!1,flash_swf_url:this.options.ajax_flash_path,silverlight_xap_url:this.options.ajax_silverlight_path,chunk_size:this.options.ajax_chunk_size+"kb",dragdrop:!0,multipart:!0,filters:this.options.filters,page_url:this.options.page_url},this.uploader=new plupload.Uploader(t),this.uploader.bind("Init",function(e,t){n.pluploadFallback.remove(),n.pluploadContainer.removeClass("fabrikHide"),e.features.dragdrop&&e.settings.dragdrop&&n.addDropArea()}),this.uploader.bind("FilesRemoved",function(e,t){}),this.uploader.bind("FilesAdded",function(e,t){n.removeDropArea();var o,s=Fabrik.bootstrapped?"tr":"li";n.lastAddedFiles=t,Fabrik.bootstrapped&&n.container.find("thead").css("display",""),o=n.droplist.find(s).length,d.each(t,function(e,t){var i,a;t.size>1e3*n.options.max_file_size?window.alert(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_FILE_TOO_LARGE_SHORT")):o>=n.options.ajax_max?window.alert(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_MAX_UPLOAD_REACHED")):(o++,a=(n.isImage(t)?(i=n.editImgButton(),n.options.crop?i.html(n.options.resizeButton):i.html(n.options.previewButton),d(document.createElement("span"))):(i=d(document.createElement("span")),d(document.createElement("a")).attr({href:t.url,target:"_blank"}))).text(t.name),a=n.imageCells(t,a,i),n.droplist.append(d(document.createElement(s)).attr({id:t.id,class:"plupload_delete"}).append(a)))}),setTimeout(function(){e.start()},100)}),this.uploader.bind("UploadProgress",function(e,t){var i,a,o=d("#"+t.id);0<o.length&&(Fabrik.bootstrapped?((i=o.find(".plupload_file_status .bar")).css("width",t.percent+"%"),100===t.percent&&(a=d(Fabrik.jLayouts["fabrik-progress-bar-success"]),i.replaceWith(a))):o.find(".plupload_file_status").text(t.percent+"%"))}),this.uploader.bind("Error",function(e,t){n.lastAddedFiles.each(function(e){e=d("#"+e.id);0<e.length&&(e.remove(),window.alert(t.message)),n.addDropArea()})}),this.uploader.bind("ChunkUploaded",function(e,t,i){"object"==typeof(i=JSON.parse(i.response))&&i.error&&fconsole(i.error.message)}),this.uploader.bind("FileUploaded",function(e,t,i){var a,o,s=d("#"+t.id);(i=JSON.parse(i.response)).error?(window.alert(i.error),s.remove()):0===s.length?fconsole("Filuploaded didnt find: "+t.id):((a=s.find(".plupload_resize a")).show(),a.attr({href:i.uri,id:"resizebutton_"+t.id}),a.data("filepath",i.filepath),n.widget&&(a=!1!==i.showWidget,n.widget.setImage(i.uri,i.filepath,t.params,a)),a=n.options.inRepeatGroup?n.options.elementName.replace(/\[\d*\]/,"["+n.getRepeatNum()+"]"):n.options.elementName,d(document.createElement("input")).attr({type:"hidden",name:a+"[crop]["+i.filepath+"]",id:"coords_"+t.id,value:JSON.stringify(t.params)}).insertAfter(n.pluploadContainer),d(document.createElement("input")).attr({type:"hidden",name:a+"[cropdata]["+i.filepath+"]",id:"data_"+t.id}).insertAfter(n.pluploadContainer),o=[t.recordid,"0"].pick(),d(document.createElement("input")).attr({type:"hidden",name:a+"[id]["+i.filepath+"]",id:"id_"+t.id,value:o}).insertAfter(n.pluploadContainer),s.removeClass("plupload_file_action").addClass("plupload_done"),n.isSubmitDone())}),this.uploader.init())},imageCells:function(e,t,i){var a,o,s=this.deleteImgButton();return Fabrik.bootstrapped?(a=d(document.createElement("td")).addClass(this.options.spanNames[1]+" plupload_resize").append(i),o=Fabrik.jLayouts["fabrik-progress-bar"],o=d(document.createElement("td")).addClass(this.options.spanNames[5]+" plupload_file_status").html(o),[d(document.createElement("td")).addClass(this.options.spanNames[6]+" plupload_file_name").append(t),a,o,s]):[new Element("div",{class:"plupload_file_name"}).adopt([t,new Element("div",{class:"plupload_resize",style:"display:none"}).adopt(i)]),s,o=new Element("div",{class:"plupload_file_status"}).set("text","0%"),new Element("div",{class:"plupload_file_size"}).set("text",e.size),new Element("div",{class:"plupload_clearer"})]},editImgButton:function(){var t=this;return Fabrik.bootstrapped?d(document.createElement("a")).addClass("editImage").attr({href:"#",alt:Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_RESIZE")}).css({display:"none"}).on("click",function(e){e.preventDefault(),t.pluploadResize(d(this))}):new Element("a",{href:"#",alt:Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_RESIZE"),events:{click:function(e){e.stop();e=e.target.getParent();this.pluploadResize(d(e))}.bind(this)}})},deleteImgButton:function(){var e,t;return Fabrik.bootstrapped?(e=Fabrik.jLayouts["fabrik-icon-delete"],t=this,d(document.createElement("td")).addClass(this.options.spanNames[1]+" plupload_file_action").append(d(document.createElement("a")).html(e).attr({href:"#"}).on("click",function(e){e.stopPropagation(),t.pluploadRemoveFile(e)}))):new Element("div",{class:"plupload_file_action"}).adopt(new Element("a",{href:"#",style:"display:block",events:{click:function(e){this.pluploadRemoveFile(e)}.bind(this)}}))},isImage:function(e){return void 0!==e.type?"image"===e.type:(e=e.name.split(".").pop().toLowerCase(),["jpg","jpeg","png","gif"].contains(e))},pluploadRemoveFile:function(t){var i,a,o,e;t.stopPropagation(),window.confirm(Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_CONFIRM_HARD_DELETE"))&&(i=d(t.target).closest("tr").prop("id").split("_").pop(),e=d(t.target).closest("tr").find(".plupload_file_name").text(),a=[],this.uploader.files.each(function(e){e.id!==i&&a.push(e)}),this.uploader.files=a,(e={option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"fileupload",method:"ajax_deleteFile",element_id:(o=this).options.id,file:e,recordid:i,repeatCounter:this.options.repeatCounter})[this.options.ajaxToken]=1,d.ajax({url:"",data:e}).done(function(e){""===(e=JSON.parse(e)).error&&(Fabrik.trigger("fabrik.fileupload.delete.complete",o),d(t.target).closest(".plupload_delete").remove(),d("#id_alreadyuploaded_"+o.options.id+"_"+i).remove(),d("#coords_alreadyuploaded_"+o.options.id+"_"+i).remove(),0===d(o.getContainer()).find("table tbody tr.plupload_delete").length)&&o.addDropArea()}))},pluploadResize:function(e){this.widget&&this.widget.setImage(e.attr("href"),e.data("filepath"),{},!0)},isSubmitDone:function(){this.allUploaded()&&"function"==typeof this.submitCallBack&&(this.saveWidgetState(),this.submitCallBack(!0),delete this.submitCallBack)},onsubmit:function(e){this.submitCallBack=e,this.allUploaded()?(this.saveWidgetState(),this.parent(e)):this.uploader.start()},saveWidgetState:function(){void 0!==this.widget&&d.each(this.widget.images,function(e,t){e=e.split("\\").pop();var i,e=d('input[name*="'+e+'"]').filter(function(e,t){return t.name.contains("[crop]")});0<(e=e.last()).length&&(i=t.img,delete t.img,e.val(JSON.stringify(t)),t.img=i)})},allUploaded:function(){var t=!0;return this.uploader&&this.uploader.files.each(function(e){0===e.loaded&&(t=!1)}),t}});var i=new Class({initialize:function(e,t){this.modalId=e,Fabrik.Windows[this.modalId]&&(Fabrik.Windows[this.modalId].options.destroy=!0,Fabrik.Windows[this.modalId].close()),this.imageDefault={rotation:0,scale:100,imagedim:{x:200,y:200,w:400,h:400},cropdim:{x:75,y:25,w:150,h:50}},d.extend(this.imageDefault,t),this.windowopts={id:this.modalId,type:"modal",loadMethod:"html",width:parseInt(this.imageDefault.imagedim.w,10)+40,height:parseInt(this.imageDefault.imagedim.h,10)+170,storeOnClose:!0,createShowOverLay:!1,crop:t.crop,destroy:!1,modalId:t.modalId,quality:t.quality,onClose:function(){this.storeActiveImageData()}.bind(this),onContentLoaded:function(){this.center()},onOpen:function(){this.center()}},this.windowopts.title=t.crop?Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_CROP_AND_SCALE"):Joomla.JText._("PLG_ELEMENT_FILEUPLOAD_PREVIEW"),this.showWin(),this.canvas=d(this.window).find("canvas")[0],this.images={},this.CANVAS=new FbCanvas({canvasElement:this.canvas,enableMouse:!0,cacheCtxPos:!1}),this.CANVAS.layers.add(new Layer({id:"bg-layer"})),this.CANVAS.layers.add(new Layer({id:"image-layer"})),t.crop&&(this.CANVAS.layers.add(new Layer({id:"overlay-layer"})),this.CANVAS.layers.add(new Layer({id:"crop-layer"})));e=new CanvasItem({id:"bg",scale:1,events:{onDraw:function(e){(e=void 0===e?this.CANVAS.ctx:e).fillStyle="#DFDFDF",e.fillRect(0,0,this.imageDefault.imagedim.w/this.scale,this.imageDefault.imagedim.h/this.scale)}.bind(this)}});this.CANVAS.layers.get("bg-layer").add(e),t.crop&&(this.overlay=new CanvasItem({id:"overlay",events:{onDraw:function(e){var t,i,a,o;void 0===e&&(e=this.CANVAS.ctx),this.overlay.withinCrop&&(i=t=0,a={x:this.imageDefault.imagedim.w,y:this.imageDefault.imagedim.h},e.fillStyle="rgba(0, 0, 0, 0.3)",o=this.cropperCanvas,e.fillRect(t,i,a.x,o.y-o.h/2),e.fillRect(t-o.w/2,i+o.y-o.h/2,t+o.x,o.h),e.fillRect(t+o.x+o.w-o.w/2,i+o.y-o.h/2,a.x,o.h),e.fillRect(t,i+(o.y+o.h)-o.h/2,a.x,a.y))}.bind(this)}}),this.CANVAS.layers.get("overlay-layer").add(this.overlay)),this.imgCanvas=this.makeImgCanvas(),this.CANVAS.layers.get("image-layer").add(this.imgCanvas),this.cropperCanvas=this.makeCropperCanvas(),t.crop&&this.CANVAS.layers.get("crop-layer").add(this.cropperCanvas),this.makeThread(),this.watchZoom(),this.watchRotate(),this.watchClose(),this.win.close()},setImage:function(e,t,i,a){var o,s;a=a||!1,this.activeFilePath=t,this.images.hasOwnProperty(t)?(i=this.images[t],this.img=i.img,this.setInterfaceDimensions(i),a&&this.showWin()):(o=i,s=Asset.image(e,{crossOrigin:"anonymous",onLoad:function(){var e=this.storeImageDimensions(t,d(s),o);this.img=e.img,this.setInterfaceDimensions(e),this.showWin(),this.storeActiveImageData(t),a||this.win.close()}.bind(this)}))},setInterfaceDimensions:function(e){this.scaleSlide&&this.scaleSlide.set(e.scale),this.rotateSlide&&this.rotateSlide.set(e.rotation),this.cropperCanvas&&e.cropdim&&(this.cropperCanvas.x=e.cropdim.x,this.cropperCanvas.y=e.cropdim.y,this.cropperCanvas.w=e.cropdim.w,this.cropperCanvas.h=e.cropdim.h),this.imgCanvas.w=e.mainimagedim.w,this.imgCanvas.h=e.mainimagedim.h,this.imgCanvas.x=void 0!==e.imagedim?e.imagedim.x:0,this.imgCanvas.y=void 0!==e.imagedim?e.imagedim.y:0},storeImageDimensions:function(e,t,i){t.appendTo(document.body).css({display:"none"}),i=i||new CloneObject(this.imageDefault,!0,[]);var a=t[0].getDimensions(!0);return i.imagedim?i.mainimagedim=i.imagedim:i.mainimagedim={},i.mainimagedim.w=a.width,i.mainimagedim.h=a.height,i.img=t[0],this.images[e]=i},makeImgCanvas:function(){var s=this;return new CanvasItem({id:"imgtocrop",w:this.imageDefault.imagedim.w,h:this.imageDefault.imagedim.h,x:200,y:200,interactive:!0,rotation:0,scale:1,offset:[0,0],events:{onMousemove:function(e,t){var i,a;this.dragging&&(i=this.w*this.scale,a=this.h*this.scale,this.x=e-this.offset[0]+.5*i,this.y=t-this.offset[1]+.5*a)},onDraw:function(e){if(e=s.CANVAS.ctx,void 0!==s.img){var t=this.w*this.scale,i=this.h*this.scale,a=this.x-.5*t,o=this.y-.5*i;if(e.save(),e.translate(this.x,this.y),e.rotate(this.rotation*Math.PI/180),this.hover?e.strokeStyle="#f00":e.strokeStyle="#000",e.strokeRect(-.5*t,-.5*i,t,i),void 0!==s.img)try{e.drawImage(s.img,-.5*t,-.5*i,t,i)}catch(e){}e.restore(),void 0!==s.img&&s.images.hasOwnProperty(s.activeFilePath)&&(s.images[s.activeFilePath].imagedim={x:this.x,y:this.y,w:t,h:i}),this.setDims(a,o,t,i)}},onMousedown:function(e,t){s.CANVAS.setDrag(this),this.offset=[e-this.dims[0],t-this.dims[1]],this.dragging=!0},onMouseup:function(){s.CANVAS.clearDrag(),this.dragging=!1},onMouseover:function(){s.overImg=!0,document.body.style.cursor="move"},onMouseout:function(){s.overImg=!1,s.overCrop||(document.body.style.cursor="default")}}})},makeCropperCanvas:function(){var s=this;return new CanvasItem({id:"item",x:175,y:175,w:150,h:50,interactive:!0,offset:[0,0],events:{onDraw:function(e){var t,i,a,o;void 0!==(e=s.CANVAS.ctx)&&(t=this.w,i=this.h,a=this.x-.5*t,o=this.y-.5*i,e.save(),e.translate(this.x,this.y),this.hover?e.strokeStyle="#f00":e.strokeStyle="#000",e.strokeRect(-.5*t,-.5*i,t,i),e.restore(),void 0!==s.img&&s.images.hasOwnProperty(s.activeFilePath)&&(s.images[s.activeFilePath].cropdim={x:this.x,y:this.y,w:t,h:i}),this.setDims(a,o,t,i))},onMousedown:function(e,t){s.CANVAS.setDrag(this),this.offset=[e-this.dims[0],t-this.dims[1]],this.dragging=!0,s.overlay.withinCrop=!0},onMousemove:function(e,t){var i,a;document.body.style.cursor="move",this.dragging&&(i=this.w,a=this.h,this.x=e-this.offset[0]+.5*i,this.y=t-this.offset[1]+.5*a)},onMouseup:function(){s.CANVAS.clearDrag(),this.dragging=!1,s.overlay.withinCrop=!1},onMouseover:function(){this.hover=!0,s.overCrop=!0},onMouseout:function(){s.overImg||(document.body.style.cursor="default"),s.overCrop=!1,this.hover=!1}}})},makeThread:function(){var e=this;this.CANVAS.addThread(new Thread({id:"myThread",onExec:function(){void 0!==e.CANVAS&&void 0!==e.CANVAS.ctxEl&&e.CANVAS.clear().draw()}}))},watchClose:function(){var t=this;this.window.find("input[name=close-crop]").on("click",function(e){t.storeActiveImageData(),t.win.close()})},storeActiveImageData:function(e){var t,i,a,o,s,n,r;void 0!==(e=e||this.activeFilePath)&&(t=this.cropperCanvas.x,i=this.cropperCanvas.y,t-=(a=this.cropperCanvas.w-2)/2,i-=(o=this.cropperCanvas.h-2)/2,0===(s=d("#"+this.windowopts.id)).length?fconsole("storeActiveImageData no window found for "+this.windowopts.id):(s=s.find("canvas"),r=(n=d(document.createElement("canvas")).attr({width:a+"px",height:o+"px"}).appendTo(document.body))[0].getContext("2d"),e=e.split("\\").pop(),e=d('input[name*="'+e+'"]').filter(function(e,t){return t.name.contains("cropdata")}),r.drawImage(s[0],t,i,a,o,0,0,a,o),e.val(n[0].toDataURL("image/jpeg",this.windowopts.quality)),n.remove()))},watchZoom:function(){var t,i=this;this.windowopts.crop&&(t=this.window.find("input[name=zoom-val]"),this.scaleSlide=new Slider(this.window.find(".fabrikslider-line")[0],this.window.find(".knob")[0],{range:[20,300],onChange:function(e){if(i.imgCanvas.scale=e/100,void 0!==i.img)try{i.images[i.activeFilePath].scale=e}catch(e){fconsole("didnt get active file path:"+i.activeFilePath)}t.val(e)}}).set(100),t.on("change",function(e){i.scaleSlide.set(d(this).val())}))},watchRotate:function(){var t,e,i;this.windowopts.crop&&(e=(t=this).window.find(".rotate"),i=this.window.find("input[name=rotate-val]"),this.rotateSlide=new Slider(e.find(".fabrikslider-line")[0],e.find(".knob")[0],{onChange:function(e){if(t.imgCanvas.rotation=e,void 0!==t.img)try{t.images[t.activeFilePath].rotation=e}catch(e){fconsole("rorate err"+t.activeFilePath)}i.val(e)},steps:360}).set(0),i.on("change",function(){t.rotateSlide.set(d(this).val())}))},showWin:function(){this.win=Fabrik.getWindow(this.windowopts),this.window=d("#"+this.modalId),void 0!==this.CANVAS&&(void 0!==this.CANVAS.ctxEl&&(this.CANVAS.ctxPos=document.id(this.CANVAS.ctxEl).getPosition()),void 0!==this.CANVAS.threads&&void 0!==this.CANVAS.threads.get("myThread")&&this.CANVAS.threads.get("myThread").start(),this.win.drawWindow(),this.win.center())}});return window.FbFileUpload});